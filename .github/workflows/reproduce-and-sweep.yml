name: reproduce-and-sweep

on:
  workflow_dispatch:
    inputs:
      n_obs:   { description: "number of observations", default: "40" }
      grid:    { description: "grid size",              default: "80" }
      noise:   { description: "observation noise",      default: "0.1" }
      vx:      { description: "flow vx",                default: "1.0" }
      vy:      { description: "flow vy",                default: "0.3" }
      seed:    { description: "random seed",            default: "7" }
      push_to_artifacts_branch:
        description: "push results to artifacts branch"
        default: "false"

permissions:
  contents: write

jobs:
  sweep-baseline:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lp: [20, 30, 40]
        lc: [6, 8, 12]
    name: baseline-lp${{ matrix.lp }}-lc${{ matrix.lc }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - run: pip install -r requirements.txt

      - name: Generate synthetic data
        run: |
          python scripts/generate_synth.py \
            --n_obs ${{ github.event.inputs.n_obs }} \
            --grid ${{ github.event.inputs.grid }} \
            --noise ${{ github.event.inputs.noise }} \
            --vx ${{ github.event.inputs.vx }} \
            --vy ${{ github.event.inputs.vy }} \
            --seed ${{ github.event.inputs.seed }}

      - name: Run baseline GP
        run: |
          retry() { for i in 1 2 3; do "$@" && return 0 || sleep 5; done; return 1; }
          retry python scripts/run_baseline.py \
            --length_parallel ${{ matrix.lp }} \
            --length_cross ${{ matrix.lc }} \
            --alpha 1e-6 --fast_loo

      - uses: actions/upload-artifact@v4
        with:
          name: baseline-lp${{ matrix.lp }}-lc${{ matrix.lc }}
          path: |
            data/metrics.json
            figures/*.png

  aggregate:
    needs: sweep-baseline
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
      - run: pip install pandas matplotlib seaborn
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge results & make heatmap
        run: |
          mkdir -p summary
          python scripts/sweep_lengths.py \
            --lp_list 20 30 40 --lc_list 6 8 12

      - uses: actions/upload-artifact@v4
        with:
          name: sweep-summary
          path: summary/

      - name: Push to artifacts branch
        if: ${{ github.event.inputs.push_to_artifacts_branch == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin
          git switch artifacts || git switch --orphan artifacts
          cp -r summary/* .
          git add summary/
          git commit -m "update artifacts from workflow run" || echo "no changes"
          git push origin HEAD:artifacts
